metadata:
  name: AI-Generated Transformation
  version: '1.0'
  source_ontology: http://example.org/manufacturing#
  target_ontology: http://example.org/ghg-report#
  description: Transformation rules generated by Claude AI with enhanced prompt
  generated_by: AI
  ai_model: claude-sonnet-4

constants:
  defaults:
    unknown_value: Unknown
  emission_factors:
    electricity: 0.5
    natural_gas: 2.03
    diesel: 2.68
    fuel_oil: 2.68
    gasoline: 2.31
  scope_classification:
    scope1:
      - natural_gas
      - diesel
      - fuel_oil
      - gasoline
    scope2:
      - electricity

root_mapping:
  target_type: ghg:EmissionReport
  target_context:
    ghg: http://example.org/ghg-report#
    xsd: http://www.w3.org/2001/XMLSchema#

field_mappings:
  - source_path: organization.name
    target_path: reporting_organization.organization_name
    default: '${constants.defaults.unknown_value}'

calculation_rules:
  - name: calculate_co2_emission
    description: Calculate CO2 emissions from energy consumption
    input:
      energy_amount: $.amount
      energy_type: $.energy_type.name
    formula: energy_amount * emission_factor
    lookup:
      emission_factor:
        source: constants.emission_factors
        key: energy_type
        key_transform: lowercase_underscore
        default: 0.0
    output: co2_amount
    rounding: 2

  - name: determine_scope
    description: Determine if emission is Scope 1 or Scope 2
    input:
      energy_type: $.energy_type.name
    logic:
      - condition:
          key_transform: lowercase_underscore
          check: energy_type in constants.scope_classification.scope1
        output: 1
      - condition:
          key_transform: lowercase_underscore
          check: energy_type in constants.scope_classification.scope2
        output: 2
      - default: 1
    output: scope

transformation_steps:
  - name: transform_activities_to_emissions
    description: Transform manufacturing activities to emissions
    source: manufacturing_activities
    target: emissions
    iteration: true
    substeps:
      - name: iterate_energy_consumptions
        description: Process each energy consumption
        source: $.energy_consumptions
        iteration: true
        mapping:
          - target: '@type'
            calculation: determine_scope
            format: 'ghg:Scope{scope}Emission'

          - target: emission_source
            source: $.activity_name
            context: parent

          - target: source_category
            source: $.energy_type.name

          - target: co2_amount
            calculation: calculate_co2_emission

          - target: calculation_method
            fixed_value: 'Activity-based calculation using standard emission factors'

          - target: emission_factor
            lookup:
              source: constants.emission_factors
              key: $.energy_type.name
              key_transform: lowercase_underscore
              default: 0.0

  - name: calculate_totals
    description: Calculate aggregated totals
    aggregations:
      - name: total_scope1
        description: Sum of Scope 1 emissions
        source: emissions
        filter:
          field: '@type'
          value: 'ghg:Scope1Emission'
        aggregate:
          function: sum
          field: co2_amount
        target: total_scope1
        rounding: 2

      - name: total_scope2
        description: Sum of Scope 2 emissions
        source: emissions
        filter:
          field: '@type'
          value: 'ghg:Scope2Emission'
        aggregate:
          function: sum
          field: co2_amount
        target: total_scope2
        rounding: 2

      - name: total_emissions
        description: Sum of all emissions
        source: emissions
        aggregate:
          function: sum
          field: co2_amount
        target: total_emissions
        rounding: 2

  - name: generate_report_metadata
    description: Generate report-level metadata
    field_mappings:
      - target: report_id
        formula: "'GHG-' + organization.name[:3].upper() + '-' + reporting_period"
        default: 'GHG-UNK-2024-01'

      - target: reporting_period
        source: manufacturing_activities[0].start_date
        format: 'YYYY-MM'
        default: '2024-01'

      - target: report_date
        value: current_date
        format: 'YYYY-MM-DD'

options:
  preserve_source_context: true
  case_sensitive: false
  null_handling: use_defaults
